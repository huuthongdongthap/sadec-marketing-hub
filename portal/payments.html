<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="../favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n - Client Portal</title>
    <meta name="description"
        content="Online payment portal supporting VNPay, MoMo, and bank transfer for invoices and services.">

    <script type="importmap">
    {"imports": {"@material/web/": "https://esm.run/@material/web/"}}
    </script>
    <script type="module">import '@material/web/all.js';</script>

    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/m3-agency.css">
    <link rel="stylesheet" href="../assets/css/portal.css">

    <!-- payOS SDK -->
    <script src="https://cdn.payos.vn/payos-checkout/v1/stable/payos-initialize.js"></script>

    <style>
        .portal-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        @media (max-width: 1024px) {
            .portal-layout {
                grid-template-columns: 1fr;
            }
        }

        .main-content {
            background: var(--md-sys-color-surface);
            padding: 32px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title {
            font: var(--md-sys-typescale-headline-medium);
        }

        /* Payment Grid */
        .payment-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 32px;
        }

        @media (max-width: 1100px) {
            .payment-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Outstanding Invoices */
        .invoices-section {}

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font: var(--md-sys-typescale-title-large);
        }

        .invoice-card {
            background: var(--md-sys-color-surface-container-low);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 24px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .invoice-card:hover {
            border-color: var(--md-sys-color-primary);
        }

        .invoice-card.selected {
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            background: var(--md-sys-color-primary-container);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .invoice-number {
            font: var(--md-sys-typescale-title-medium);
            font-weight: 600;
        }

        .invoice-date {
            font: var(--md-sys-typescale-body-small);
            color: var(--md-sys-color-on-surface-variant);
        }

        .invoice-status {
            padding: 4px 12px;
            border-radius: 24px;
            font: var(--md-sys-typescale-label-small);
        }

        .invoice-status.pending {
            background: #FFF3E0;
            color: #E65100;
        }

        .invoice-status.overdue {
            background: #FFEBEE;
            color: #C62828;
        }

        .invoice-status.paid {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .invoice-items {
            border-top: 1px solid var(--md-sys-color-outline-variant);
            padding-top: 16px;
            margin-bottom: 16px;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font: var(--md-sys-typescale-body-medium);
        }

        .invoice-item-name {
            color: var(--md-sys-color-on-surface-variant);
        }

        .invoice-total {
            display: flex;
            justify-content: space-between;
            padding-top: 16px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
            font: var(--md-sys-typescale-title-medium);
            font-weight: 600;
        }

        .invoice-total .amount {
            color: var(--md-sys-color-primary);
        }

        /* Payment Panel */
        .payment-panel {
            background: var(--md-sys-color-surface-container-low);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-extra-large);
            padding: 32px;
            position: sticky;
            top: 32px;
        }

        .panel-title {
            font: var(--md-sys-typescale-headline-small);
            margin-bottom: 24px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font: var(--md-sys-typescale-body-medium);
        }

        .summary-row.total {
            font: var(--md-sys-typescale-title-large);
            font-weight: 600;
            border-top: 1px solid var(--md-sys-color-outline-variant);
            padding-top: 16px;
            margin-top: 16px;
        }

        .summary-row.total .amount {
            color: var(--md-sys-color-primary);
        }

        /* Payment Methods */
        .payment-methods {
            margin-top: 24px;
            margin-bottom: 24px;
        }

        .method-title {
            font: var(--md-sys-typescale-label-large);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 12px;
        }

        .method-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .method-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            transition: all 0.2s;
        }

        .method-option:hover {
            border-color: var(--md-sys-color-primary);
            background: var(--md-sys-color-surface-container);
        }

        .method-option.selected {
            border-color: var(--md-sys-color-primary);
            background: var(--md-sys-color-primary-container);
        }

        .method-logo {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 24px;
        }

        .method-logo.vnpay {
            background: #F7F7F7;
            color: #1A1F71;
        }

        .method-logo.momo {
            background: #D82D8B;
            color: white;
        }

        .method-logo.payos {
            background: #0088FF;
            color: white;
        }

        .method-logo.bank {
            background: #E3F2FD;
            color: #1565C0;
        }

        .method-info {
            flex: 1;
        }

        .method-name {
            font: var(--md-sys-typescale-title-small);
        }

        .method-desc {
            font: var(--md-sys-typescale-body-small);
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Bank Info */
        .bank-info {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 20px;
            margin-top: 16px;
            display: none;
        }

        .bank-info.visible {
            display: block;
        }

        .bank-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font: var(--md-sys-typescale-body-medium);
        }

        .bank-row .label {
            color: var(--md-sys-color-on-surface-variant);
        }

        .bank-row .value {
            font-weight: 500;
        }

        .copy-btn {
            cursor: pointer;
            color: var(--md-sys-color-primary);
        }

        /* QR Code */
        .qr-section {
            text-align: center;
            margin-top: 24px;
            padding: 24px;
            background: white;
            border-radius: var(--md-sys-shape-corner-medium);
            display: none;
        }

        .qr-section.visible {
            display: block;
        }

        .qr-code {
            width: 180px;
            height: 180px;
            background: #f0f0f0;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            border: 2px solid var(--md-sys-color-outline-variant);
        }

        .qr-hint {
            font: var(--md-sys-typescale-body-small);
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Loading & Modal Styles */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-extra-large);
            padding: 32px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .modal-icon.error { color: #C62828; }
        .modal-icon.success { color: #2E7D32; }
        .modal-icon.info { color: #1565C0; }

        .modal-title {
            font: var(--md-sys-typescale-headline-small);
            margin-bottom: 12px;
        }

        .modal-message {
            font: var(--md-sys-typescale-body-medium);
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 24px;
            white-space: pre-line;
        }

        /* History */
        .history-section {
            margin-top: 40px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--md-sys-color-surface-container-low);
            border-radius: var(--md-sys-shape-corner-large);
            overflow: hidden;
        }

        .history-table th,
        .history-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .history-table th {
            font: var(--md-sys-typescale-label-large);
            color: var(--md-sys-color-on-surface-variant);
            background: var(--md-sys-color-surface-container);
        }

        .history-table td {
            font: var(--md-sys-typescale-body-medium);
        }
    </style>
</head>

<body>
    <div class="portal-layout">
        <!-- Sidebar -->
        <sadec-sidebar role="client" active="payments"></sadec-sidebar>

        <!-- Main Content -->
        <main class="main-content" role="main">
            <div class="page-header">
                <div>
                    <h1 class="page-title">üí≥ Thanh To√°n</h1>
                    <div class="body-medium text-muted">Thanh to√°n h√≥a ƒë∆°n nhanh ch√≥ng v√† an to√†n</div>
                </div>
            </div>

            <div class="payment-layout">
                <!-- Invoices List -->
                <div class="invoices-section">
                    <div class="section-header">
                        <div class="section-title">H√≥a ƒë∆°n ch·ªù thanh to√°n</div>
                    </div>

                    <!-- Invoice 1 - Overdue -->
                    <div class="invoice-card selected" data-amount="8500000">
                        <div class="invoice-header">
                            <div>
                                <div class="invoice-number">#INV-2026-001</div>
                                <div class="invoice-date">Ng√†y t·∫°o: 01/01/2026</div>
                            </div>
                            <span class="invoice-status overdue">‚ö†Ô∏è Qu√° h·∫°n 10 ng√†y</span>
                        </div>
                        <div class="invoice-items">
                            <div class="invoice-item">
                                <span class="invoice-item-name">G√≥i Social Media Pro - Th√°ng 1</span>
                                <span>6,000,000 ‚Ç´</span>
                            </div>
                            <div class="invoice-item">
                                <span class="invoice-item-name">Qu·∫£ng c√°o Facebook Ads</span>
                                <span>2,000,000 ‚Ç´</span>
                            </div>
                            <div class="invoice-item">
                                <span class="invoice-item-name">Thi·∫øt k·∫ø banner (5 m·∫´u)</span>
                                <span>500,000 ‚Ç´</span>
                            </div>
                        </div>
                        <div class="invoice-total">
                            <span>T·ªïng c·ªông</span>
                            <span class="amount">8,500,000 ‚Ç´</span>
                        </div>
                    </div>

                    <!-- Invoice 2 - Pending -->
                    <div class="invoice-card" data-amount="15000000">
                        <div class="invoice-header">
                            <div>
                                <div class="invoice-number">#INV-2026-002</div>
                                <div class="invoice-date">Ng√†y t·∫°o: 15/01/2026</div>
                            </div>
                            <span class="invoice-status pending">‚è≥ Ch·ªù thanh to√°n</span>
                        </div>
                        <div class="invoice-items">
                            <div class="invoice-item">
                                <span class="invoice-item-name">G√≥i Full Agency - Th√°ng 2</span>
                                <span>15,000,000 ‚Ç´</span>
                            </div>
                        </div>
                        <div class="invoice-total">
                            <span>T·ªïng c·ªông</span>
                            <span class="amount">15,000,000 ‚Ç´</span>
                        </div>
                    </div>

                    <!-- Payment History -->
                    <div class="history-section">
                        <div class="section-header">
                            <div class="section-title">L·ªãch s·ª≠ thanh to√°n</div>
                        </div>
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>M√£ Hƒê</th>
                                    <th>Ng√†y TT</th>
                                    <th>S·ªë ti·ªÅn</th>
                                    <th>Ph∆∞∆°ng th·ª©c</th>
                                    <th>Tr·∫°ng th√°i</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>#INV-2025-012</strong></td>
                                    <td>20/12/2025</td>
                                    <td>6,000,000 ‚Ç´</td>
                                    <td>üèß VNPay</td>
                                    <td><span class="invoice-status paid">‚úÖ ƒê√£ thanh to√°n</span></td>
                                </tr>
                                <tr>
                                    <td><strong>#INV-2025-011</strong></td>
                                    <td>15/11/2025</td>
                                    <td>8,500,000 ‚Ç´</td>
                                    <td>üì± MoMo</td>
                                    <td><span class="invoice-status paid">‚úÖ ƒê√£ thanh to√°n</span></td>
                                </tr>
                                <tr>
                                    <td><strong>#INV-2025-010</strong></td>
                                    <td>01/11/2025</td>
                                    <td>6,000,000 ‚Ç´</td>
                                    <td>üè¶ Chuy·ªÉn kho·∫£n</td>
                                    <td><span class="invoice-status paid">‚úÖ ƒê√£ thanh to√°n</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payment Panel -->
                <div class="payment-panel">
                    <div class="panel-title">üõí Thanh to√°n</div>

                    <div class="summary-row">
                        <span>H√≥a ƒë∆°n #INV-2026-001</span>
                        <span>8,500,000 ‚Ç´</span>
                    </div>

                    <div class="summary-row total">
                        <span>T·ªïng thanh to√°n</span>
                        <span class="amount" id="total-amount">8,500,000 ‚Ç´</span>
                    </div>

                    <!-- Payment Methods -->
                    <div class="payment-methods">
                        <div class="method-title">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</div>
                        <div class="method-options">
                            <div class="method-option selected" data-method="vnpay">
                                <div class="method-logo vnpay">üí≥</div>
                                <div class="method-info">
                                    <div class="method-name">VNPay</div>
                                    <div class="method-desc">Th·∫ª ATM, Visa, MasterCard</div>
                                </div>
                                <span class="material-symbols-outlined"
                                    style="color: var(--md-sys-color-primary);">check_circle</span>
                            </div>

                            <div class="method-option" data-method="momo">
                                <div class="method-logo momo">üì±</div>
                                <div class="method-info">
                                    <div class="method-name">MoMo</div>
                                    <div class="method-desc">V√≠ ƒëi·ªán t·ª≠ MoMo</div>
                                </div>
                            </div>

                            <div class="method-option" data-method="payos">
                                <div class="method-logo payos">üí∞</div>
                                <div class="method-info">
                                    <div class="method-name">payOS</div>
                                    <div class="method-desc">QR Code - M·ªçi ng√¢n h√†ng</div>
                                </div>
                            </div>

                            <div class="method-option" data-method="bank">
                                <div class="method-logo bank">üè¶</div>
                                <div class="method-info">
                                    <div class="method-name">Chuy·ªÉn kho·∫£n</div>
                                    <div class="method-desc">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bank Info (for bank transfer) -->
                    <div class="bank-info" id="bank-info">
                        <div class="bank-row">
                            <span class="label">Ng√¢n h√†ng</span>
                            <span class="value">Vietcombank</span>
                        </div>
                        <div class="bank-row">
                            <span class="label">S·ªë t√†i kho·∫£n</span>
                            <span class="value">
                                1234567890
                                <span class="copy-btn material-symbols-outlined"
                                    style="font-size: 16px;">content_copy</span>
                            </span>
                        </div>
                        <div class="bank-row">
                            <span class="label">Ch·ªß t√†i kho·∫£n</span>
                            <span class="value">MEKONG AGENCY</span>
                        </div>
                        <div class="bank-row">
                            <span class="label">N·ªôi dung CK</span>
                            <span class="value">
                                INV2026001
                                <span class="copy-btn material-symbols-outlined"
                                    style="font-size: 16px;">content_copy</span>
                            </span>
                        </div>
                    </div>

                    <!-- QR Section -->
                    <div class="qr-section" id="qr-section">
                        <div class="qr-code">
                            <span style="font-size: 80px;">üì±</span>
                        </div>
                        <div class="qr-hint">Qu√©t m√£ QR b·∫±ng app VNPay/MoMo ƒë·ªÉ thanh to√°n</div>
                    </div>

                    <md-filled-button style="width: 100%; margin-top: 24px;" id="pay-btn">
                        <span class="material-symbols-outlined" slot="icon">lock</span>
                        Thanh to√°n 8,500,000 ‚Ç´
                    </md-filled-button>

                    <div style="text-align: center; margin-top: 16px;">
                        <span
                            style="font: var(--md-sys-typescale-body-small); color: var(--md-sys-color-on-surface-variant);">
                            üîí Thanh to√°n ƒë∆∞·ª£c b·∫£o m·∫≠t b·ªüi SSL
                        </span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Error/Info Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon" id="modal-icon">‚ö†Ô∏è</div>
            <h2 class="modal-title" id="modal-title">Th√¥ng b√°o</h2>
            <p class="modal-message" id="modal-message">ƒê√¢y l√† th√¥ng b√°o m·∫´u.</p>
            <div>
                <md-filled-button onclick="closeModal()">ƒê√≥ng</md-filled-button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase, auth } from '../assets/js/supabase.js';

        const SUPABASE_URL = 'https://pzcgvfhppglzfjavxuid.supabase.co';

        // Modal helper functions
        function showModal(type, title, message) {
            const modal = document.getElementById('modal-overlay');
            const icon = document.getElementById('modal-icon');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');

            // Set icon based on type
            if (type === 'error') {
                icon.textContent = '‚ö†Ô∏è';
                icon.className = 'modal-icon error';
            } else if (type === 'success') {
                icon.textContent = '‚úÖ';
                icon.className = 'modal-icon success';
            } else if (type === 'info') {
                icon.textContent = '‚ÑπÔ∏è';
                icon.className = 'modal-icon info';
            }

            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.classList.add('visible');
        }

        window.closeModal = function() {
            document.getElementById('modal-overlay').classList.remove('visible');
        };

        // Close modal when clicking overlay
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'modal-overlay') {
                closeModal();
            }
        });

        // Select invoice
        document.querySelectorAll('.invoice-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.invoice-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                const amount = parseInt(card.dataset.amount).toLocaleString('vi-VN');
                document.getElementById('total-amount').textContent = amount + ' ‚Ç´';
                document.getElementById('pay-btn').textContent = 'Thanh to√°n ' + amount + ' ‚Ç´';
            });
        });

        // Payment method selection
        document.querySelectorAll('.method-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.method-option').forEach(o => {
                    o.classList.remove('selected');
                    o.querySelector('.material-symbols-outlined')?.remove();
                });
                option.classList.add('selected');
                option.insertAdjacentHTML('beforeend', '<span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">check_circle</span>');

                const method = option.dataset.method;
                const bankInfo = document.getElementById('bank-info');
                const qrSection = document.getElementById('qr-section');

                if (method === 'bank') {
                    bankInfo.classList.add('visible');
                    qrSection.classList.remove('visible');
                } else if (method === 'vnpay' || method === 'momo' || method === 'payos') {
                    bankInfo.classList.remove('visible');
                    qrSection.classList.add('visible');
                }
            });
        });

        // Copy to clipboard
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const text = btn.previousSibling.textContent.trim();
                navigator.clipboard.writeText(text);
                btn.textContent = 'done';
                setTimeout(() => btn.textContent = 'content_copy', 2000);
            });
        });

        // Pay button
        document.getElementById('pay-btn').addEventListener('click', async () => {
            const methodOption = document.querySelector('.method-option.selected');
            if (!methodOption) {
                showModal('error', 'L·ªói', 'Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n');
                return;
            }

            const method = methodOption.dataset.method;
            const invoiceCard = document.querySelector('.invoice-card.selected');

            if (!invoiceCard) {
                showModal('error', 'L·ªói', 'Vui l√≤ng ch·ªçn h√≥a ƒë∆°n c·∫ßn thanh to√°n');
                return;
            }

            if (method === 'bank') {
                showModal('info', 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng', 'Vui l√≤ng chuy·ªÉn kho·∫£n theo th√¥ng tin ·ªü tr√™n.\n\nSau khi chuy·ªÉn kho·∫£n, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông x√°c nh·∫≠n trong 5-10 ph√∫t.');
            } else if (method === 'vnpay' || method === 'momo' || method === 'payos') {
                const btn = document.getElementById('pay-btn');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div> ƒêang x·ª≠ l√Ω...';

                try {
                    // Get invoice details
                    const amountStr = invoiceCard.dataset.amount; // e.g. "8500000"
                    const amount = parseInt(amountStr);
                    const invoiceNumber = invoiceCard.querySelector('.invoice-number').textContent.trim(); // e.g. "#INV-2026-001"
                    const cleanInvoiceId = invoiceNumber.replace('#', ''); // "INV-2026-001"

                    // Determine endpoint based on method
                    let endpoint = '';
                    if (method === 'vnpay') {
                        endpoint = 'create-payment';
                    } else if (method === 'momo') {
                        endpoint = 'create-momo-payment';
                    } else if (method === 'payos') {
                        endpoint = 'create-payos-payment';
                    }

                    // Call Edge Function with invoiceNumber (breaking change fix)
                    const { data: { session } } = await supabase.auth.getSession();
                    const token = session?.access_token;

                    const response = await fetch(`${SUPABASE_URL}/functions/v1/${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token || ''}`
                        },
                        body: JSON.stringify({
                            invoiceNumber: cleanInvoiceId,  // ‚úÖ FIXED: Added invoiceNumber
                            invoiceId: cleanInvoiceId,       // Keep for backward compatibility
                            amount: amount,
                            orderInfo: `Thanh toan hoa don ${cleanInvoiceId}`,
                            paymentMethod: method
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Payment creation failed');
                    }

                    if (result.success && (result.paymentUrl || result.checkoutUrl)) {
                        // Redirect to Payment Gateway
                        const redirectUrl = result.checkoutUrl || result.paymentUrl;

                        // For payOS, use SDK if available, otherwise redirect
                        if (method === 'payos' && window.PayOSCheckout && result.checkoutUrl) {
                            // PayOS SDK embedded checkout (optional)
                            const payosConfig = {
                                checkoutUrl: redirectUrl,
                                onSuccess: (data) => {
                                    window.location.href = `payment-result.html?code=00&status=PAID&orderCode=${result.orderCode || ''}`;
                                },
                                onCancel: () => {
                                    window.location.href = `payment-result.html?cancel=true&orderCode=${result.orderCode || ''}`;
                                },
                                onError: (error) => {
                                    showModal('error', 'L·ªói PayOS', error.message || 'C√≥ l·ªói x·∫£y ra');
                                    btn.disabled = false;
                                    btn.textContent = originalText;
                                }
                            };

                            // Use PayOS embedded checkout
                            window.PayOSCheckout.open(payosConfig);
                        } else {
                            // Standard redirect for all gateways
                            window.location.href = redirectUrl;
                        }
                    } else {
                        throw new Error(result.error || 'Invalid response from server');
                    }

                } catch (error) {
                    console.error('Payment Error:', error);
                    showModal('error', 'L·ªói thanh to√°n', error.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } else {
                showModal('error', 'Kh√¥ng h·ªó tr·ª£', 'Ph∆∞∆°ng th·ª©c thanh to√°n ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£.');
            }
        });
    </script>

    <script type="module" src="../assets/js/components/sadec-sidebar.js"></script>
    <script type="module" src="../assets/js/portal-client.js"></script>
    <script src="../assets/js/admin-shared.js"></script>
</body>

</html>